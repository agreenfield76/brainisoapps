(this["webpackJsonpsciso-app-ex"]=this["webpackJsonpsciso-app-ex"]||[]).push([[0],{44:function(e,t,n){},51:function(e,t,n){},52:function(e,t,n){"use strict";n.r(t);var a=n(1),r=n.n(a),c=n(21),s=n.n(c),i=(n(44),n(14)),o=n(5),l=n(25),d=n(26),u=n(27),b=n(30),h=n(62),m=n(59),f=n(63),j=n(13),x=n(66),g=n(68),p=n(61),O=n(67),v=n(69),_=n(17),N=n(11),w=n(4),y=n.n(w),S=n(22),C=n(24),k=n.n(C),E=(n(46),n(0));function W(e){var t=Object(a.useState)([]),n=Object(o.a)(t,2),r=n[0],c=n[1],s=Object(a.useRef)(null);return Object(a.useEffect)((function(){(function(){var e=Object(S.a)(y.a.mark((function e(){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Object(m.a)("https://sciso.gandallab.org/ex/gene_names").then((function(e){c(e.genes)}));case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}})()()}),[]),Object(a.useEffect)((function(){var e=r.map((function(e){return{label:e[1],value:e[0]}})),t=k()(s.current).selectize({mode:"multi",maxItems:1,valueField:"label",labelField:"label",searchField:"label",options:e,create:!1,closeAfterSelect:!0,selectOnTab:!0,maxOptions:100,plugins:["remove_button"]});return function(){t[0].selectize.destroy()}}),[r]),Object(E.jsx)("div",{className:"card bg-light",style:{width:"18rem"},children:Object(E.jsxs)("div",{className:"card-body",children:[Object(E.jsx)("h5",{className:"card-title",children:"Enter a gene:"}),Object(E.jsxs)("form",{className:"row gx-3",onSubmit:function(t){e.onChange(s.current.value),t.preventDefault()},children:[Object(E.jsx)("div",{className:"col",children:Object(E.jsx)("input",{type:"text",className:"form-control",ref:s,defaultValue:e.gene})}),Object(E.jsx)("div",{className:"col-auto",children:Object(E.jsx)("button",{type:"submit",className:"btn btn-primary",children:"Submit"})})]})]})})}var D=n(36);function R(e){Object(a.useEffect)((function(){(function(){var t=Object(S.a)(y.a.mark((function t(){return y.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:Object(m.a)("https://sciso.gandallab.org/ex/dataset").then((function(t){var n,a=t.datasets.map((function(e){return e.isChecked=!0,e})),r=a.filter((function(e){return e.is_reference}));(n=a=a.filter((function(e){return!e.is_reference}))).unshift.apply(n,Object(D.a)(r)),e.onChange(a)}));case 1:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}})()()}),[]);var t=e.datasets.map((function(t,n){return Object(E.jsx)(G,{dataset:t,i:n,onChange:function(){return function(t){var n=e.datasets;n[t].isChecked=!n[t].isChecked,e.onChange(n)}(n)}},t.id)}));return Object(E.jsxs)("div",{children:[Object(E.jsx)("h5",{children:"Datasets"}),Object(E.jsx)("form",{children:t})]})}function G(e){var t=e.dataset;return Object(E.jsxs)("div",{className:"form-check form-switch",children:[Object(E.jsx)("input",{className:"form-check-input",type:"checkbox",name:t.name,checked:t.isChecked,onChange:e.onChange}),Object(E.jsx)("label",{className:"form-check-label",children:t.name})]})}n(50),n(51);var B=function(e){Object(u.a)(n,e);var t=Object(b.a)(n);function n(e){var a;return Object(l.a)(this,n),(a=t.call(this,e)).state={data:null,loading:!1},a}return Object(d.a)(n,[{key:"componentDidUpdate",value:function(e){var t=this;this.props.gene!==e.gene&&(this.setState({loading:!0}),Object(m.a)("https://sciso.gandallab.org/ex/gene?geneId="+this.props.gene).then((function(e){t.setState({data:e,loading:!1})})))}},{key:"render",value:function(){var e=this.state.loading,t=this.state.data,n=this.props.datasets;return e?Object(E.jsx)("span",{style:{color:"red"},children:"Spinner"}):t?Object(E.jsx)(L,{data:t,datasets:n}):null}}]),n}(r.a.Component);function L(e){var t={bandWidth:16,paddingOuter:40,paddingInner:5,labelWidth:120,rectsWidth:1156,paddingX:10,height:1e3,bubblesAxisHeight:25,bubblesWidth:0,bubblesDiam:20};t.width=t.labelWidth+t.rectsWidth+t.bubblesWidth+2*t.paddingX;var n=e.data,r=n.transcripts.filter((function(e){return e.is_model}))[0].exons,c=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:7;e.sort((function(e,t){return Number(e.chrom_start)<Number(t.chrom_start)?-1:Number(e.chrom_start)>Number(t.chrom_start)?1:0}));var r=0,c=0;e.forEach((function(t,n){if(t.length=Number(t.chrom_end)-Number(t.chrom_start)+1,r+=t.length,0==n)t.intronLength=0;else{var a=e[n-1];t.intronLength=Number(t.chrom_start)-Number(a.chrom_end)+1}c+=t.intronLength}));var s=[0,r],i=[0,c],o=[0,.7*t-e.length*a],l=[0,.3*t-e.length*n];return[function(e){return n+Object(j.a)().domain(s).range(o).interpolate(p.a).call(null,e)},function(e){return a+Object(j.a)().domain(i).range(l).interpolate(p.a).call(null,e)}]}(r,t.rectsWidth),s=Object(o.a)(c,2),i=s[0],l=s[1];r.forEach((function(e,t){e.x=0==t?0:r[t-1].x+r[t-1].w+l(e.intronLength),e.w=i(e.length)}));var d=e.datasets.filter((function(e){return e.isChecked})).map((function(e){return e.id})),u=n.transcripts.filter((function(e){return!e.is_model&&d.includes(e.dataset_id)})),b=u.filter((function(e){return e.attributes.expression})).map((function(e){return e.attributes.expression}));u.sort((function(e,t){return d.indexOf(e.dataset_id)-d.indexOf(t.dataset_id)}));var m=Object(j.a)().domain([0,Object(h.a)(b,(function(e){return Object(h.a)(e,(function(e){return e.pct_exp}))}))]).range([1,t.bubblesDiam/2]).interpolate(p.a),_=Object(x.a)().domain([-.5,2.5]).interpolator(Object(O.a)("lightgrey","blue")),N=b[0]?Object(g.a)().domain(b[0].map((function(e){return e.cell_type}))).range([0,t.bubblesWidth-t.bubblesDiam]).padding(0).round(!0):null,w=u.map((function(n,a){return Object(E.jsx)(T,{data:n,modelExons:r,exonScale:i,intronScale:l,expressionRadiusScale:m,expressionColorScale:_,expressionXScale:N,i:a,dims:t,datasets:e.datasets.reduce((function(e,t){return e[t.id]=t,e}),{}),showBubbles:false},n.id)}));return Object(a.useEffect)((function(){N&&Object(f.a)(".GeneVizFrame svg .BubblesAxis").empty()?Object(f.a)(".GeneVizFrame svg").append("g").attr("class","BubblesAxis").attr("transform","translate(".concat(t.labelWidth+t.rectsWidth+2*t.paddingX,",").concat(t.bubblesAxisHeight,")")).call(Object(v.a)(N)).call((function(e){return e.select(".domain").remove()})).call((function(e){return e.selectAll("line").remove()})).selectAll("text").attr("y",0).attr("x",9).attr("dy",".35em").attr("transform","rotate(90)").style("text-anchor","end"):N||Object(f.a)(".GeneVizFrame svg .BubblesAxis").remove()})),t.height=2*t.paddingOuter+t.bandWidth*u.length+t.paddingInner*(u.length-1),Object(E.jsx)("div",{className:"GeneVizFrame my-3",style:{width:t.width},children:Object(E.jsxs)("svg",{viewBox:"0 0 ".concat(t.width," ").concat(t.height),xmlns:"http://www.w3.org/2000/svg",children:[Object(E.jsx)("style",{children:"\n          text {\n            font-family: sans-serif;\n            font-size: 10px;\n          }\n\n          .ExonRect {\n            fill: rgb(238, 238, 238);\n            stroke: black;\n            stroke-width: 1px;\n            /*shape-rendering: crispEdges;*/\n          }\n                    \n          .TranscriptID.reference {\n            fill:seagreen;\n          }\n          \n          .TranscriptID.novel {\n            fill:steelblue;\n          }\n          \n          .ExonRect.novel {\n            fill:steelblue;\n          }\n          \n          .ExonRect.reference {\n            fill:seagreen;\n          }\n        "}),w]})})}function T(e){var t=Object(_.b)(),n=Object(o.a)(t,2),a=n[0],r=n[1],c=e.exonScale,s=(e.intronScale,e.modelExons),i=e.data.annot_transcript_id,l=e.dims,d=e.data.is_model?{}:e.datasets[e.data.dataset_id],u=d.is_reference,b=e.data.exons;b.forEach((function(t,n){if(t.oriExon=F(t.chrom_start,s)||F(t.chrom_end,s),void 0!==t.oriExon){if(Number(t.oriExon.chrom_start)==Number(t.chrom_start))t.x=t.oriExon.x;else{var a=Number(t.chrom_start)-Number(t.oriExon.chrom_start)+1;t.x=t.oriExon.x+c(a)-2}void 0===t.length&&(t.length=Number(t.chrom_end)-Number(t.chrom_start)+1),t.w=c(t.length)}else console.warn("".concat(e.data.id,"-").concat(t.id," can't map to full gene model"))}));var h=b.map((function(e){return Object(E.jsx)(A,{data:e,target:r,dims:l,is_reference:u},e.id)}));return Object(E.jsxs)("g",{className:"Transcript",transform:"translate(0 ".concat(l.paddingOuter+e.i*(l.bandWidth+l.paddingInner)+.5,")"),children:[Object(E.jsx)(_.a,{allowHTML:!0,content:Object(E.jsxs)("span",{children:["Dataset: ",d.name,Object(E.jsx)("br",{}),"Transcript type: ",e.data.attributes.transcript_type,Object(E.jsx)("br",{}),"Source: ",e.data.attributes.source]}),aria:null,trigger:"mouseenter",hideOnClick:!1,interactive:!0,appendTo:document.body,followCursor:"horizontal",plugins:[N.c],children:Object(E.jsx)("text",{className:"TranscriptID ".concat("NOVEL"==e.data.attributes.transcript_status?"novel":"known"," ").concat(u?"reference":"non-reference"),textAnchor:"end",dominantBaseline:"middle",x:l.labelWidth,y:l.bandWidth/2,children:i})}),Object(E.jsx)(_.a,{singleton:a,moveTransition:"transform 0.4s cubic-bezier(0.22, 1, 0.36, 1)",delay:[0,500]}),Object(E.jsxs)("g",{className:"ExonRects",transform:"translate(".concat(l.labelWidth+l.paddingX+.5,")"),children:[Object(E.jsx)("line",{x1:b[0].x,x2:b[b.length-1].x+b[b.length-1].w,y1:l.bandWidth/2,y2:l.bandWidth/2,strokeWidth:"1",stroke:"black"}),h]}),e.showBubbles&&Object(E.jsx)(V,{data:e.data,radiusScale:e.expressionRadiusScale,colorScale:e.expressionColorScale,xScale:e.expressionXScale,dims:l})]})}function V(e){var t=e.data.attributes.expression,n=e.dims;if(!t)return null;var a=e.xScale,r=e.radiusScale,c=e.colorScale,s=t.map((function(e,t){return Object(E.jsx)(_.a,{allowHTML:!0,content:Object(E.jsxs)("span",{children:["Pct expressed: ",e.pct_exp,Object(E.jsx)("br",{}),"Avg expression: ",e.avg_exp_scaled]}),hideOnClick:!1,children:Object(E.jsx)("circle",{className:"ExpressionBubble",cx:a(e.cell_type)+.5,cy:n.bandWidth/2,r:r(e.pct_exp),fill:c(e.avg_exp_scaled)})})}));return Object(E.jsx)("g",{className:"ExpressionBubbles",transform:"translate(".concat(n.labelWidth+n.rectsWidth+2*n.paddingX,", 0)"),children:s})}function A(e){var t=e.dims;return Object(E.jsx)(_.a,{content:"Exon ".concat(e.data.exon_number,": ").concat(e.data.chrom_start," - ").concat(e.data.chrom_end," (").concat(Number(e.data.chrom_end)-Number(e.data.chrom_start)+1," bp)"),singleton:e.target,children:Object(E.jsx)("rect",{className:"ExonRect ".concat("NOVEL"==e.data.attributes.exon_status?"novel":""," ").concat(e.is_reference?"reference":""),x:e.data.x,y:"0",width:e.data.w,height:t.bandWidth})})}function F(e,t){e=Number(e);var n=t.filter((function(t){return Number(t.chrom_start)-1<=e&&Number(t.chrom_end)+1>=e}));return 1==n.length?n[0]:0==n.length?void console.warn("No exon found for: "+e):void console.warn("More than one exons found for: "+e)}var I=function(e){Object(u.a)(n,e);var t=Object(b.a)(n);function n(e){var r;return Object(l.a)(this,n),(r=t.call(this,e)).state={gene:"",datasets:[]},r.handleGeneChange=r.handleGeneChange.bind(Object(i.a)(r)),r.handleDatasetsChange=r.handleDatasetsChange.bind(Object(i.a)(r)),r.downloadSVG=r.downloadSVG.bind(Object(i.a)(r)),r.svgRef=Object(a.createRef)(),r}return Object(d.a)(n,[{key:"handleGeneChange",value:function(e){this.setState({gene:e})}},{key:"handleDatasetsChange",value:function(e){this.setState({datasets:e})}},{key:"downloadSVG",value:function(){!function(e,t){e.setAttribute("xmlns","http://www.w3.org/2000/svg");var n=e.outerHTML,a=new Blob(['<?xml version="1.0" standalone="no"?>\r\n',n],{type:"image/svg+xml;charset=utf-8"}),r=URL.createObjectURL(a),c=document.createElement("a");c.href=r,c.download=t,document.body.appendChild(c),c.click(),document.body.removeChild(c)}(document.querySelector(".GeneVizFrame svg"),"sciso")}},{key:"render",value:function(){var e=this.state.gene,t=this.state.datasets;return Object(E.jsxs)("div",{className:"container-xxl",children:[Object(E.jsx)("div",{className:"my-3",children:Object(E.jsx)("h2",{children:"Human and Mouse Brain Iso-seq and RNA-Seq"})}),Object(E.jsxs)("div",{className:"row gy-3",children:[Object(E.jsx)("div",{className:"col col-auto",children:Object(E.jsx)(W,{gene:e,onChange:this.handleGeneChange})}),Object(E.jsx)("div",{className:"col col-auto",children:Object(E.jsx)(R,{datasets:t,onChange:this.handleDatasetsChange})}),Object(E.jsx)("div",{className:"col col-auto",children:Object(E.jsx)("button",{type:"button",className:"btn btn-light",onClick:this.downloadSVG,children:"Save SVG"})})]}),Object(E.jsx)(B,{gene:e,datasets:t,svgRef:this.svgRef})]})}}]),n}(r.a.Component),z=function(e){e&&e instanceof Function&&n.e(3).then(n.bind(null,70)).then((function(t){var n=t.getCLS,a=t.getFID,r=t.getFCP,c=t.getLCP,s=t.getTTFB;n(e),a(e),r(e),c(e),s(e)}))};s.a.render(Object(E.jsx)(r.a.StrictMode,{children:Object(E.jsx)(I,{})}),document.getElementById("root")),z()}},[[52,1,2]]]);
//# sourceMappingURL=main.aa452a51.chunk.js.map